<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Affine Cipher — Tool</title>
<style>
    :root{
        --bg:#0f1724; --card:#0b1220; --accent:#7c3aed; --muted:#9aa6b2; --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    body{
        margin:0;
        font-family: Inter, Roboto, Arial, sans-serif;
        background:
          radial-gradient(1200px 600px at 10% 10%, rgba(124,58,237,0.12), transparent 8%),
          radial-gradient(1000px 500px at 90% 90%, rgba(3,105,161,0.06), transparent 8%),
          var(--bg);
        color:#e6eef7;
        min-height:100vh;
        display:flex;
        align-items:center;
        justify-content:center;
        padding:28px;
    }

    .container{
        width:100%;
        max-width:980px;
        background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
        border-radius:14px;
        box-shadow: 0 10px 30px rgba(2,6,23,0.7);
        padding:22px;
        display:grid;
        grid-template-columns: 1fr 420px;
        gap:18px;
        align-items:start;
    }

    header{
        grid-column: 1 / -1;
        display:flex;
        justify-content:space-between;
        align-items:center;
        gap:12px;
    }

    header h1{
        font-size:20px;
        margin:0;
        letter-spacing:0.2px;
    }
    header p{margin:0;color:var(--muted);font-size:13px}

    .panel{
        background:var(--card);
        border-radius:10px;
        padding:14px;
        border: 1px solid rgba(255,255,255,0.03);
    }

    .left .field{margin-bottom:12px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    textarea, input[type="text"], input[type="number"], select{
        width:100%;
        padding:10px 12px;
        border-radius:8px;
        border:1px solid rgba(255,255,255,0.04);
        background:var(--glass);
        color:inherit;
        font-size:14px;
        outline:none;
        resize:vertical;
    }
    textarea{min-height:140px; max-height:300px}
    .row{display:flex;gap:10px}
    .row > *{flex:1}

    .actions{display:flex;gap:8px;margin-top:10px}
    button{
        padding:10px 12px;
        border-radius:8px;
        border: none;
        cursor:pointer;
        font-weight:600;
        background:linear-gradient(90deg,var(--accent), #0ea5a3);
        color:white;
        box-shadow: 0 6px 18px rgba(124,58,237,0.12);
    }
    button.ghost{
        background:transparent;
        border:1px solid rgba(255,255,255,0.06);
        color:var(--muted);
        font-weight:600;
    }
    .small{padding:8px 10px;font-size:13px}
    .note{font-size:13px;color:var(--muted);margin-top:6px}

    .right .meta{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    .chip{
        background: rgba(255,255,255,0.025);
        padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.02);
        color:var(--muted);font-size:13px;
    }

    .output{
        min-height:120px;
        white-space:pre-wrap;
        background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
        border-radius:8px;padding:12px;border:1px solid rgba(255,255,255,0.03);
        font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
        color:#dff3ff;
    }

    .warning{color:#ffcccb;font-size:13px;margin-top:8px}
    .brutelist{max-height:260px;overflow:auto;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.01)}
    .bf-item{padding:6px 6px;border-bottom:1px dashed rgba(255,255,255,0.02);font-size:13px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}

    footer{grid-column:1/-1;margin-top:8px;color:var(--muted);font-size:12px;text-align:center}
    @media (max-width:980px){
        .container{grid-template-columns: 1fr; padding:16px}
        .right{order:2}
    }
</style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Affine Cipher — Mã hóa & Giải mã</h1>
        <p>Chuẩn: Extended Euclid cho nghịch đảo, giữ nguyên ký tự không phải chữ, hỗ trợ uppercase/lowercase.</p>
      </div>
      <div style="text-align:right">
        <div class="chip">Bảng chữ: A=0..Z=25</div>
      </div>
    </header>

    <section class="panel left">
      <div class="field">
        <label for="inputText">Văn bản (Plaintext / Ciphertext)</label>
        <textarea id="inputText" placeholder="Nhập văn bản..."></textarea>
      </div>

      <div class="row">
        <div>
          <label for="keyA">Khóa a (nhân)</label>
          <input id="keyA" type="number" value="5" />
        </div>
        <div>
          <label for="keyB">Khóa b (dịch)</label>
          <input id="keyB" type="number" value="8" />
        </div>
      </div>

      <div class="controls">
        <button id="encryptBtn">Mã hóa (Encrypt)</button>
        <button id="decryptBtn">Giải mã (Decrypt)</button>
        <button id="bruteBtn" class="ghost small">Brute-force (tất cả 312)</button>
        <button id="copyOut" class="ghost small">Sao chép kết quả</button>
        <button id="clearBtn" class="ghost small">Xóa</button>
      </div>

      <div class="note">Lưu ý: giá trị <strong>a</strong> phải nguyên tố cùng nhau với 26 (vd: 1,3,5,7,9,11,15,17,19,21,23,25).</div>
      <div id="warn" class="warning" style="display:none"></div>
    </section>

    <aside class="panel right">
      <div class="meta">
        <div class="chip">a: <span id="showA">5</span></div>
        <div class="chip">b: <span id="showB">8</span></div>
        <div class="chip">a mod 26: <span id="showAMod">5</span></div>
      </div>

      <div>
        <label>Kết quả</label>
        <div id="output" class="output" aria-live="polite"></div>
      </div>

      <div style="margin-top:12px">
        <label>Kết quả brute-force (nhấp để sao chép một dòng)</label>
        <div id="bruteList" class="brutelist" title="Danh sách các kết quả brute-force"></div>
      </div>
    </aside>

    <footer>Phiên bản: 1.0 — Lưu ý: Affine là mã cổ điển, dễ phá khi văn bản dài.</footer>
  </div>

<script>
/* --- Helpers --- */
function norm26(n){
    n = Number(n) % 26;
    if (n < 0) n += 26;
    return n;
}

function egcd(a,b){
    // Extended Euclid iterative
    a = Math.floor(a); b = Math.floor(b);
    let x0=1, x1=0, y0=0, y1=1;
    while (b !== 0) {
        let q = Math.floor(a / b);
        let t = a - q * b; a = b; b = t;
        t = x0 - q * x1; x0 = x1; x1 = t;
        t = y0 - q * y1; y0 = y1; y1 = t;
    }
    return {g: a, x: x0, y: y0};
}

function modInverse26(a){
    a = norm26(a);
    const r = egcd(a,26);
    if (r.g !== 1) return null;
    return norm26(r.x);
}

function isLetter(ch){
    return /[A-Za-z]/.test(ch);
}
function baseOf(ch){ return /[A-Z]/.test(ch) ? 65 : 97; }

/* --- Affine operations --- */
function encodeChar(ch, a, b){
    if (!isLetter(ch)) return ch;
    let base = baseOf(ch);
    let x = ch.charCodeAt(0) - base;
    let y = norm26(a * x + b);
    return String.fromCharCode(y + base);
}
function decodeChar(ch, a, b){
    if (!isLetter(ch)) return ch;
    let aInv = modInverse26(a);
    if (aInv === null) return '?';
    let base = baseOf(ch);
    let y = ch.charCodeAt(0) - base;
    let x = norm26(aInv * (y - b));
    return String.fromCharCode(x + base);
}

function encryptAffine(text, a, b){
    a = norm26(a); b = norm26(b);
    let out = '';
    for (let ch of text) out += encodeChar(ch, a, b);
    return out;
}
function decryptAffine(text, a, b){
    a = norm26(a); b = norm26(b);
    let aInv = modInverse26(a);
    if (aInv === null) return null;
    let out = '';
    for (let ch of text) out += decodeChar(ch, a, b);
    return out;
}

/* --- UI bindings --- */
const inputText = document.getElementById('inputText');
const keyA = document.getElementById('keyA');
const keyB = document.getElementById('keyB');
const encryptBtn = document.getElementById('encryptBtn');
const decryptBtn = document.getElementById('decryptBtn');
const bruteBtn = document.getElementById('bruteBtn');
const outputEl = document.getElementById('output');
const warnEl = document.getElementById('warn');
const showA = document.getElementById('showA');
const showB = document.getElementById('showB');
const showAMod = document.getElementById('showAMod');
const bruteList = document.getElementById('bruteList');
const copyOut = document.getElementById('copyOut');
const clearBtn = document.getElementById('clearBtn');

function updateChips(){
    const a = Number(keyA.value || 0);
    const b = Number(keyB.value || 0);
    showA.textContent = a;
    showB.textContent = b;
    showAMod.textContent = norm26(a);
}
updateChips();

[keyA, keyB].forEach(el => el.addEventListener('input', updateChips));

function showWarning(msg){
    if (!msg) { warnEl.style.display='none'; warnEl.textContent=''; }
    else { warnEl.style.display='block'; warnEl.textContent = msg; }
}

encryptBtn.addEventListener('click', ()=> {
    showWarning('');
    const a = Number(keyA.value || 0), b = Number(keyB.value || 0);
    const aMod = norm26(a);
    // check coprime
    if (modInverse26(aMod) === null){
        showWarning('Giá trị a không hợp lệ — không có nghịch đảo modulo 26. Chọn a sao cho gcd(a,26)=1.');
        outputEl.textContent = '';
        return;
    }
    const text = inputText.value || '';
    const ct = encryptAffine(text, aMod, b);
    outputEl.textContent = ct;
    bruteList.innerHTML = '';
});

decryptBtn.addEventListener('click', ()=> {
    showWarning('');
    const a = Number(keyA.value || 0), b = Number(keyB.value || 0);
    const aMod = norm26(a);
    if (modInverse26(aMod) === null){
        showWarning('Giá trị a không hợp lệ — không có nghịch đảo modulo 26. Chọn a sao cho gcd(a,26)=1.');
        outputEl.textContent = '';
        return;
    }
    const text = inputText.value || '';
    const pt = decryptAffine(text, aMod, b);
    if (pt === null){
        showWarning('Không thể giải mã (a không có nghịch đảo).');
        outputEl.textContent = '';
        return;
    }
    outputEl.textContent = pt;
    bruteList.innerHTML = '';
});

bruteBtn.addEventListener('click', ()=> {
    showWarning('');
    bruteList.innerHTML = '';
    const text = inputText.value || '';
    if (!text){
        showWarning('Nhập bản mã để brute-force.');
        return;
    }
    const validAs = [];
    for (let a=0;a<26;a++){
        let inv = modInverse26(a);
        if (inv !== null) validAs.push(a);
    }
    // validAs.length should be 12
    let html = '';
    for (let a of validAs){
        for (let b=0;b<26;b++){
            const pt = decryptAffine(text, a, b);
            // build a clickable item
            const item = document.createElement('div');
            item.className = 'bf-item';
            item.textContent = `a=${a}, b=${b} -> ${pt}`;
            item.title = 'Nhấp để sao chép dòng này';
            item.addEventListener('click', ()=> {
                navigator.clipboard?.writeText(pt).then(()=> {
                    showWarning('Đã sao chép dòng đã chọn vào clipboard.');
                    setTimeout(()=> showWarning(''),1800);
                }).catch(()=> {
                    showWarning('Không thể sao chép — trình duyệt chặn clipboard.');
                });
            });
            bruteList.appendChild(item);
        }
    }
    outputEl.textContent = '';
});

copyOut.addEventListener('click', ()=> {
    const txt = outputEl.textContent || '';
    if (!txt) { showWarning('Chưa có kết quả để sao chép.'); return; }
    navigator.clipboard?.writeText(txt).then(()=> {
        showWarning('Đã sao chép kết quả vào clipboard.');
        setTimeout(()=> showWarning(''),1700);
    }).catch(()=> {
        showWarning('Không thể sao chép — trình duyệt chặn clipboard.');
    });
});

clearBtn.addEventListener('click', ()=> {
    inputText.value = '';
    outputEl.textContent = '';
    bruteList.innerHTML = '';
    showWarning('');
});

</script>
</body>
</html>
